<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Assistant - The Astro Spot</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Space+Grotesk:wght@700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/showdown/dist/showdown.min.js"></script>
<script defer src="/_vercel/insights/script.js"></script>
</head>
<body>

    <header class="site-header">
        <div class="container">
            <a href="index.html" class="site-logo">The Astro Spot</a>
            <nav class="main-nav"></nav> <div class="hamburger-menu" id="hamburger-menu">
                <div class="bar"></div><div class="bar"></div><div class="bar"></div>
            </div>
        </div>
    </header>
    <nav class="mobile-nav" id="mobile-nav"></nav> <main class="container">
        <div class="fade-in-section">
             <div class="chat-container">
                <h1>Astro-Assistant</h1>
                <div class="chat-log" id="chat-log"></div>
                <div class="input-area">
                    <textarea id="prompt-input" placeholder="Ask a question..."></textarea>
                    <div class="button-container">
                         <button id="clear-button">Clear</button>
                         <button id="submit-button">
                            <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 -960 960 960" width="24" fill="white"><path d="M120-160v-240l320-80-320-80v-240l760 320-760 320Z"/></svg>
                         </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="site-footer">
        <p>&copy; 2025 The Astro Spot. All Rights Reserved.</p>
    </footer>

    <script src="animations.js"></script>
    <script src="menu.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="auth.js"></script>
    <script src="protect.js"></script>
    <script>
        const chatLog = document.getElementById('chat-log');
        const promptInput = document.getElementById('prompt-input');
        const submitButton = document.getElementById('submit-button');
        const clearButton = document.getElementById('clear-button');
        const markdownConverter = new showdown.Converter();

        let chatHistory = [];
        
        // --- (saveHistory, loadHistory, renderChatHistory, clearChat, showLoadingIndicator functions remain the same) ---
        function saveHistory() { /* ... */ }
        function loadHistory() { /* ... */ }
        function renderChatHistory() { /* ... */ }
        function clearChat() { /* ... */ }
        function showLoadingIndicator() { /* ... */ }

        async function askAI() {
            const userPrompt = promptInput.value.trim();
            if (!userPrompt) return;

            // --- NEW LOGIN CHECK ---
            const currentUser = firebase.auth().currentUser;
            if (!currentUser || !currentUser.emailVerified) {
                // If the user is not logged in, show a message and stop.
                const errorEl = document.createElement('div');
                errorEl.classList.add('message', 'model-message');
                errorEl.innerHTML = `Please <a href="login.html" style="color: var(--primary-color); font-weight: bold;">log in</a> and verify your email to use the AI Assistant.`;
                chatLog.appendChild(errorEl);
                chatLog.scrollTop = chatLog.scrollHeight;
                return; // Stop the function here
            }
            // --- END OF CHECK ---

            chatHistory.push({ "role": "user", "parts": [{ "text": userPrompt }] });
            promptInput.value = '';
            renderChatHistory();
            showLoadingIndicator();
            saveHistory();
            
            submitButton.disabled = true;
            clearButton.disabled = true;
            
            const apiURL = `/api/ask`; // Use relative URL for Vercel

            try {
                const response = await fetch(apiURL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ "history": chatHistory })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                const modelResponse = data.response;
                
                chatHistory.push({ "role": "model", "parts": [{ "text": modelResponse }] });
                renderChatHistory();
                saveHistory();

            } catch (error) {
                renderChatHistory();
                const errorEl = document.createElement('div');
                errorEl.classList.add('message', 'model-message');
                errorEl.innerHTML = `Sorry, an error occurred: ${error.message}`;
                chatLog.appendChild(errorEl);
                console.error('Error:', error);
            } finally {
                submitButton.disabled = false;
                clearButton.disabled = false;
            }
        }

        // --- (Event Listeners and DOMContentLoaded remain the same) ---
        submitButton.addEventListener('click', askAI);
        clearButton.addEventListener('click', clearChat);
        promptInput.addEventListener('keydown', (event) => { /* ... */ });
        document.addEventListener('DOMContentLoaded', loadHistory);
    </script>
</body>
</html>